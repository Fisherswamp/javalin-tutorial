<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">NCTRCBackend</a> &gt; <a href="index.source.html" class="el_package">org.nctrc.backend.managers</a> &gt; <span class="el_source">DatabaseManager.java</span></div><h1>DatabaseManager.java</h1><pre class="source lang-java linenums">package org.nctrc.backend.managers;

import com.amazonaws.services.dynamodbv2.AmazonDynamoDB;
import com.amazonaws.services.dynamodbv2.AmazonDynamoDBClientBuilder;
import com.amazonaws.services.dynamodbv2.document.AttributeUpdate;
import com.amazonaws.services.dynamodbv2.document.DynamoDB;
import com.amazonaws.services.dynamodbv2.document.Item;
import com.amazonaws.services.dynamodbv2.document.ItemCollection;
import com.amazonaws.services.dynamodbv2.document.PrimaryKey;
import com.amazonaws.services.dynamodbv2.document.PutItemOutcome;
import com.amazonaws.services.dynamodbv2.document.ScanOutcome;
import com.amazonaws.services.dynamodbv2.document.Table;
import com.amazonaws.services.dynamodbv2.document.spec.GetItemSpec;
import com.amazonaws.services.dynamodbv2.document.spec.UpdateItemSpec;
import com.amazonaws.services.dynamodbv2.model.ResourceInUseException;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Properties;
import java.util.Set;
import java.util.UUID;
import javax.inject.Inject;
import javax.inject.Singleton;
import org.apache.commons.lang3.time.DateUtils;
import org.joda.time.DateTime;
import org.nctrc.backend.config.Constants;
import org.nctrc.backend.config.DatabaseConfigInformation;
import org.nctrc.backend.config.DatabaseConstants;
import org.nctrc.backend.model.internal.SigninTimeIdPair;
import org.nctrc.backend.model.request.NewUserRequestModel;
import org.nctrc.backend.model.request.SigninRequestModel;
import org.nctrc.backend.model.request.UserRequestModel;
import org.nctrc.backend.utility.Utility;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Singleton
public class DatabaseManager implements DatabaseManagerInterface {

<span class="fc" id="L46">  private static final Logger logger = LoggerFactory.getLogger(DatabaseManager.class);</span>

  private final DynamoDB database;

  private final DatabaseConstants databaseConstants;

  private final Set&lt;String&gt; tablesThatExist;

  @Inject
<span class="fc" id="L55">  public DatabaseManager(final DatabaseConstants databaseConstants) {</span>
<span class="fc" id="L56">    this.databaseConstants = databaseConstants;</span>
<span class="fc" id="L57">    this.tablesThatExist = new HashSet&lt;&gt;();</span>
<span class="fc" id="L58">    try (InputStream input =</span>
<span class="fc" id="L59">        Objects.requireNonNull(</span>
                DatabaseManager.class
<span class="fc" id="L61">                    .getClassLoader()</span>
<span class="fc" id="L62">                    .getResource(&quot;keystore/database/database.properties&quot;))</span>
<span class="fc" id="L63">            .openStream()) {</span>
<span class="fc" id="L64">      final Properties prop = new Properties();</span>
<span class="fc" id="L65">      prop.load(input);</span>
<span class="fc" id="L66">      System.setProperty(&quot;aws.accessKeyId&quot;, prop.getProperty(&quot;accessKeyId&quot;));</span>
<span class="fc" id="L67">      System.setProperty(&quot;aws.secretKey&quot;, prop.getProperty(&quot;secretAccessKey&quot;));</span>
<span class="nc" id="L68">    } catch (IOException | NullPointerException ex) {</span>
<span class="nc" id="L69">      ex.printStackTrace();</span>
<span class="fc" id="L70">    }</span>
    final AmazonDynamoDB client =
<span class="fc" id="L72">        AmazonDynamoDBClientBuilder.standard().withRegion(Constants.REGION).build();</span>
<span class="fc" id="L73">    this.database = new DynamoDB(client);</span>
<span class="fc" id="L74">  }</span>

  public void addUser(final NewUserRequestModel userRequestModel) throws InterruptedException {
<span class="fc" id="L77">    this.createTableIfNotExist(this.databaseConstants.USERS_TABLE);</span>
<span class="fc" id="L78">    final Table usersTable = this.database.getTable(this.databaseConstants.USERS_TABLE);</span>
<span class="fc" id="L79">    usersTable.waitForActive();</span>
<span class="fc" id="L80">    final Item newUserItem = new Item();</span>
<span class="fc" id="L81">    newUserItem.withPrimaryKey(&quot;email&quot;, userRequestModel.getUser().getEmail());</span>
<span class="fc" id="L82">    Constants.ISO_8601.setTimeZone(Constants.TIME_ZONE);</span>
<span class="fc" id="L83">    newUserItem.with(&quot;createDate&quot;, Constants.ISO_8601.format(new Date()));</span>
<span class="fc" id="L84">    newUserItem.with(&quot;firstName&quot;, userRequestModel.getUser().getFirstName());</span>
<span class="fc" id="L85">    newUserItem.with(&quot;lastName&quot;, userRequestModel.getUser().getLastName());</span>
<span class="fc" id="L86">    newUserItem.with(&quot;signature&quot;, userRequestModel.getSignature());</span>
    try {
<span class="fc" id="L88">      final PutItemOutcome outcome = usersTable.putItem(newUserItem);</span>
<span class="fc" id="L89">      logger.debug(&quot;New User inserted into database:\n&quot; + outcome.getPutItemResult());</span>
<span class="nc" id="L90">    } catch (Exception e) {</span>
<span class="nc" id="L91">      logger.error(&quot;Unable to add new user with error: &quot; + e.toString());</span>
<span class="fc" id="L92">    }</span>
<span class="fc" id="L93">  }</span>

  public void removeUser(final UserRequestModel userRequestModel) throws InterruptedException {
<span class="fc" id="L96">    this.createTableIfNotExist(this.databaseConstants.USERS_TABLE);</span>
<span class="fc" id="L97">    final Table usersTable = this.database.getTable(this.databaseConstants.USERS_TABLE);</span>
<span class="fc" id="L98">    usersTable.waitForActive();</span>
<span class="fc" id="L99">    usersTable.deleteItem(new PrimaryKey(&quot;email&quot;, userRequestModel.getEmail()));</span>
<span class="fc" id="L100">    this.createTableIfNotExist(this.databaseConstants.TIMELINE_TABLE);</span>
<span class="fc" id="L101">    final Table timelineTable = this.database.getTable(this.databaseConstants.TIMELINE_TABLE);</span>
<span class="fc" id="L102">    timelineTable.waitForActive();</span>
<span class="fc" id="L103">    final ItemCollection&lt;ScanOutcome&gt; outcomeItemCollection = timelineTable.scan();</span>
<span class="fc" id="L104">    final List&lt;Item&gt; timelinesWithUserToDelete = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L105">    outcomeItemCollection.forEach(</span>
        item -&gt; {
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">          if (userRequestModel.getEmail().equals(item.getString(&quot;userEmail&quot;))) {</span>
<span class="fc" id="L108">            timelinesWithUserToDelete.add(item);</span>
          }
<span class="fc" id="L110">        });</span>
<span class="fc" id="L111">    timelinesWithUserToDelete.forEach(</span>
        timeLineToDelete -&gt; {
<span class="fc" id="L113">          timelineTable.deleteItem(</span>
              new PrimaryKey(
                  &quot;id&quot;,
<span class="fc" id="L116">                  timeLineToDelete.getString(&quot;id&quot;),</span>
                  &quot;signinTime&quot;,
<span class="fc" id="L118">                  timeLineToDelete.getString(&quot;signinTime&quot;)));</span>
<span class="fc" id="L119">        });</span>
<span class="fc" id="L120">  }</span>

  /**
   * This function signs in a user and returns the uuid of the signin/signout datapoint
   *
   * @param signinRequestModel Model of request to sign a user in
   * @return String of uuid for signin/signout to be found later
   * @throws InterruptedException
   */
  public SigninTimeIdPair signinUser(final SigninRequestModel signinRequestModel)
      throws InterruptedException {
<span class="fc" id="L131">    this.createTableIfNotExist(this.databaseConstants.TIMELINE_TABLE);</span>
<span class="fc" id="L132">    final Table timelineTable = this.database.getTable(this.databaseConstants.TIMELINE_TABLE);</span>
<span class="fc" id="L133">    timelineTable.waitForActive();</span>
<span class="fc" id="L134">    final Item newTimelineItem = new Item();</span>
<span class="fc" id="L135">    final String id = UUID.randomUUID().toString();</span>
<span class="fc" id="L136">    final String signinTime = Utility.nowToFullIso8601String();</span>
<span class="fc" id="L137">    newTimelineItem.withPrimaryKey(&quot;id&quot;, id, &quot;signinTime&quot;, signinTime);</span>
<span class="fc" id="L138">    newTimelineItem.with(&quot;userEmail&quot;, signinRequestModel.getUser().getEmail());</span>
<span class="fc" id="L139">    newTimelineItem.with(&quot;firstName&quot;, signinRequestModel.getUser().getFirstName());</span>
<span class="fc" id="L140">    newTimelineItem.with(&quot;lastName&quot;, signinRequestModel.getUser().getLastName());</span>
<span class="fc" id="L141">    newTimelineItem.with(&quot;temperature&quot;, signinRequestModel.getSigninData().getTemperature());</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">    if (signinRequestModel.getSigninData().getYesQuestion() != null) {</span>
<span class="nc" id="L143">      newTimelineItem.with(&quot;yesQuestion&quot;, signinRequestModel.getSigninData().getYesQuestion());</span>
    }
    try {
<span class="fc" id="L146">      final PutItemOutcome outcome = timelineTable.putItem(newTimelineItem);</span>
<span class="fc" id="L147">      logger.debug(&quot;New User inserted into database:\n&quot; + outcome.getPutItemResult());</span>
<span class="nc" id="L148">    } catch (Exception e) {</span>
<span class="nc" id="L149">      logger.error(&quot;Unable to add new user with error: &quot; + e.toString());</span>
<span class="nc" id="L150">      throw new InterruptedException(&quot;Unable to add new user with error: &quot; + e.toString());</span>
<span class="fc" id="L151">    }</span>
<span class="fc" id="L152">    return new SigninTimeIdPair(id, signinTime);</span>
  }

  public void signOutUser(final SigninTimeIdPair signInTimeAndId) throws InterruptedException {
<span class="fc" id="L156">    signOutUser(signInTimeAndId, Utility.nowToFullIso8601String());</span>
<span class="fc" id="L157">  }</span>

  public void signOutUser(final SigninTimeIdPair signInTimeAndId, final String signoutTime)
      throws InterruptedException {
<span class="fc" id="L161">    final Table timelineTable = this.database.getTable(this.databaseConstants.TIMELINE_TABLE);</span>
<span class="fc" id="L162">    timelineTable.waitForActive();</span>
<span class="fc" id="L163">    timelineTable.updateItem(</span>
        new UpdateItemSpec()
<span class="fc" id="L165">            .withPrimaryKey(</span>
<span class="fc" id="L166">                &quot;id&quot;, signInTimeAndId.getId(), &quot;signinTime&quot;, signInTimeAndId.getSigninTime())</span>
<span class="fc" id="L167">            .withAttributeUpdate(new AttributeUpdate(&quot;signoutTime&quot;).put(signoutTime)));</span>
<span class="fc" id="L168">  }</span>

  public int loadMaxCapacity() throws InterruptedException {
<span class="nc" id="L171">    createTableIfNotExist(this.databaseConstants.CONFIG_TABLE);</span>
<span class="nc" id="L172">    final Table configTable = this.database.getTable(this.databaseConstants.CONFIG_TABLE);</span>
<span class="nc" id="L173">    configTable.waitForActive();</span>
<span class="nc" id="L174">    final Item maxCapacityItem =</span>
<span class="nc" id="L175">        configTable.getItem(</span>
            new GetItemSpec()
<span class="nc" id="L177">                .withPrimaryKey(</span>
<span class="nc" id="L178">                    this.databaseConstants.CONFIG_PRIMARY_KEY,</span>
<span class="nc" id="L179">                    this.databaseConstants.CONFIG_MAX_CAPACITY));</span>
<span class="nc" id="L180">    return maxCapacityItem.getInt(this.databaseConstants.CONFIG_VALUE);</span>
  }

  public void setMaxCapacity(final int newMaxCapacity) throws InterruptedException {
<span class="nc" id="L184">    createTableIfNotExist(this.databaseConstants.CONFIG_TABLE);</span>
<span class="nc" id="L185">    final Table configTable = this.database.getTable(this.databaseConstants.CONFIG_TABLE);</span>
<span class="nc" id="L186">    configTable.waitForActive();</span>
<span class="nc" id="L187">    configTable.updateItem(</span>
        new UpdateItemSpec()
<span class="nc" id="L189">            .withPrimaryKey(</span>
<span class="nc" id="L190">                this.databaseConstants.CONFIG_PRIMARY_KEY,</span>
<span class="nc" id="L191">                this.databaseConstants.CONFIG_MAX_CAPACITY)</span>
<span class="nc" id="L192">            .withAttributeUpdate(</span>
<span class="nc" id="L193">                new AttributeUpdate(this.databaseConstants.CONFIG_VALUE).put(newMaxCapacity)));</span>
<span class="nc" id="L194">  }</span>

  @Override
  public List&lt;UserRequestModel&gt; getAllUsers() throws InterruptedException {
<span class="fc" id="L198">    final List&lt;UserRequestModel&gt; users = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L199">    createTableIfNotExist(this.databaseConstants.USERS_TABLE);</span>
<span class="fc" id="L200">    final Table usersTable = this.database.getTable(this.databaseConstants.USERS_TABLE);</span>
<span class="fc" id="L201">    usersTable.waitForActive();</span>
<span class="fc" id="L202">    final ItemCollection&lt;ScanOutcome&gt; outcomeItemCollection = usersTable.scan();</span>
<span class="fc" id="L203">    outcomeItemCollection.forEach(</span>
        item -&gt; {
<span class="fc" id="L205">          users.add(</span>
              new UserRequestModel(
<span class="fc" id="L207">                  item.get(&quot;firstName&quot;).toString(),</span>
<span class="fc" id="L208">                  item.get(&quot;lastName&quot;).toString(),</span>
<span class="fc" id="L209">                  item.get(&quot;email&quot;).toString()));</span>
<span class="fc" id="L210">        });</span>
<span class="fc" id="L211">    return users;</span>
  }

  public Map&lt;UserRequestModel, SigninTimeIdPair&gt; getAllUsersWhoAreSignedInDatabase()
      throws InterruptedException {
<span class="fc" id="L216">    createTableIfNotExist(this.databaseConstants.TIMELINE_TABLE);</span>
<span class="fc" id="L217">    final Table timelineTable = this.database.getTable(this.databaseConstants.TIMELINE_TABLE);</span>
<span class="fc" id="L218">    timelineTable.waitForActive();</span>
<span class="fc" id="L219">    final ItemCollection&lt;ScanOutcome&gt; outcomeItemCollection = timelineTable.scan();</span>
<span class="fc" id="L220">    final Map&lt;UserRequestModel, SigninTimeIdPair&gt; usersStillSignedIn = new HashMap&lt;&gt;();</span>
<span class="fc" id="L221">    outcomeItemCollection.forEach(</span>
        item -&gt; {
<span class="fc" id="L223">          final DateTime signinTime = DateTime.parse(item.getString(&quot;signinTime&quot;));</span>
<span class="fc" id="L224">          final long yesterday = DateUtils.addDays(new Date(), -1).getTime();</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">          if (signinTime.isAfter(yesterday)) {</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">            if (item.getString(&quot;signoutTime&quot;) == null) {</span>
<span class="fc" id="L227">              usersStillSignedIn.put(</span>
                  new UserRequestModel(
<span class="fc" id="L229">                      item.getString(&quot;firstName&quot;),</span>
<span class="fc" id="L230">                      item.getString(&quot;lastName&quot;),</span>
<span class="fc" id="L231">                      item.getString(&quot;userEmail&quot;)),</span>
<span class="fc" id="L232">                  new SigninTimeIdPair(item.getString(&quot;id&quot;), item.getString(&quot;signinTime&quot;)));</span>
            }
          }
<span class="fc" id="L235">        });</span>
<span class="fc" id="L236">    return usersStillSignedIn;</span>
  }

  private void createTableIfNotExist(final String tableName) {
<span class="fc bfc" id="L240" title="All 2 branches covered.">    if (this.tablesThatExist.contains(tableName)) {</span>
<span class="fc" id="L241">      return;</span>
    }
<span class="fc" id="L243">    final DatabaseConfigInformation configInformation =</span>
<span class="fc" id="L244">        databaseConstants.TABLE_CONFIG.get(tableName);</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">    if (configInformation == null) {</span>
<span class="nc" id="L246">      logger.error(&quot;Can't resolve table name: &quot; + tableName);</span>
<span class="nc" id="L247">      return;</span>
    }
    try {
<span class="fc" id="L250">      final Table table =</span>
<span class="nc" id="L251">          this.database.createTable(</span>
<span class="fc" id="L252">              configInformation.getTableName(),</span>
<span class="fc" id="L253">              configInformation.getKeySchemaElements(),</span>
<span class="fc" id="L254">              configInformation.getAttributeDefinitions(),</span>
              databaseConstants.PROVISIONED_THROUGHPUT);
<span class="nc" id="L256">      table.waitForActive();</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">      if (tableName.equals(databaseConstants.CONFIG_TABLE)) {</span>
<span class="nc" id="L258">        table.putItem(</span>
            new Item()
<span class="nc" id="L260">                .withPrimaryKey(</span>
<span class="nc" id="L261">                    this.databaseConstants.CONFIG_PRIMARY_KEY,</span>
<span class="nc" id="L262">                    this.databaseConstants.CONFIG_MAX_CAPACITY)</span>
<span class="nc" id="L263">                .with(this.databaseConstants.CONFIG_VALUE, databaseConstants.DEFAULT_MAX_CAPACITY));</span>
      }
<span class="nc" id="L265">      this.tablesThatExist.add(tableName);</span>
<span class="nc" id="L266">      logger.debug(&quot;Create new table &quot; + tableName);</span>
<span class="fc" id="L267">    } catch (ResourceInUseException e) {</span>
<span class="fc" id="L268">      this.tablesThatExist.add(tableName);</span>
<span class="fc" id="L269">      logger.debug(&quot;Not Creating new table &quot; + tableName + &quot; - it already exists&quot;);</span>
<span class="nc" id="L270">    } catch (InterruptedException e) {</span>
<span class="nc" id="L271">      logger.error(&quot;Unable to create table &quot; + tableName + &quot;: &quot; + e.toString());</span>
<span class="pc" id="L272">    }</span>
<span class="fc" id="L273">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>