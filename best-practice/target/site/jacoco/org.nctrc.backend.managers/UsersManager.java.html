<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsersManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">NCTRCBackend</a> &gt; <a href="index.source.html" class="el_package">org.nctrc.backend.managers</a> &gt; <span class="el_source">UsersManager.java</span></div><h1>UsersManager.java</h1><pre class="source lang-java linenums">package org.nctrc.backend.managers;

import java.util.Date;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import javax.inject.Inject;
import javax.inject.Singleton;
import org.nctrc.backend.config.Constants;
import org.nctrc.backend.config.DatabaseConstants;
import org.nctrc.backend.model.internal.DayTimeline;
import org.nctrc.backend.model.internal.SigninTimeIdPair;
import org.nctrc.backend.model.request.NewUserRequestModel;
import org.nctrc.backend.model.request.SigninDataRequestModel;
import org.nctrc.backend.model.request.SigninRequestModel;
import org.nctrc.backend.model.request.UserRequestModel;
import org.nctrc.backend.model.response.Result;
import org.nctrc.backend.model.response.UserExistsResult;
import org.nctrc.backend.utility.Utility;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Singleton
public class UsersManager {

<span class="fc" id="L26">  private static final Logger logger = LoggerFactory.getLogger(UsersManager.class);</span>

  private final Set&lt;UserRequestModel&gt; users;

  private final DayTimeline signinTimeLine;

  private final DatabaseManagerInterface databaseManager;

  private int maxCapacity;

  private int currentCapacity;

  @Inject
  public UsersManager(
<span class="fc" id="L40">      final DatabaseManagerInterface databaseManager, final DatabaseConstants databaseConstants) {</span>
<span class="fc" id="L41">    users = new HashSet&lt;&gt;();</span>
<span class="fc" id="L42">    signinTimeLine = new DayTimeline(new Date());</span>
<span class="fc" id="L43">    this.databaseManager = databaseManager;</span>
    try {
<span class="fc" id="L45">      this.maxCapacity = databaseManager.loadMaxCapacity();</span>
<span class="nc" id="L46">    } catch (InterruptedException e) {</span>
<span class="nc" id="L47">      this.maxCapacity = databaseConstants.DEFAULT_MAX_CAPACITY;</span>
<span class="fc" id="L48">    }</span>
<span class="fc" id="L49">    this.currentCapacity = 0;</span>
    try {
<span class="fc" id="L51">      users.addAll(databaseManager.getAllUsers());</span>
<span class="fc" id="L52">      users.forEach(signinTimeLine::addUser);</span>
<span class="nc" id="L53">    } catch (InterruptedException e) {</span>
<span class="nc" id="L54">      logger.warn(&quot;Unable to load users from database: &quot; + e.toString());</span>
<span class="fc" id="L55">    }</span>
    try {
<span class="fc" id="L57">      final Map&lt;UserRequestModel, SigninTimeIdPair&gt; usersSignedIn =</span>
<span class="fc" id="L58">          databaseManager.getAllUsersWhoAreSignedInDatabase();</span>
<span class="fc" id="L59">      usersSignedIn</span>
<span class="fc" id="L60">          .keySet()</span>
<span class="fc" id="L61">          .forEach(</span>
              userRequestModel -&gt; {
<span class="nc" id="L63">                signinTimeLine.signUserIn(userRequestModel, usersSignedIn.get(userRequestModel));</span>
<span class="nc" id="L64">                this.currentCapacity++;</span>
<span class="nc" id="L65">              });</span>
<span class="nc" id="L66">    } catch (InterruptedException e) {</span>
<span class="nc" id="L67">      logger.warn(&quot;Unable to load signed in users from database: &quot; + e.toString());</span>
<span class="fc" id="L68">    }</span>
<span class="fc" id="L69">  }</span>

  public Result signinUser(final SigninRequestModel signinRequestModel) {
<span class="fc" id="L72">    final UserRequestModel user = signinRequestModel.getUser();</span>
    final Result result;
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">    if (users.contains(user)) {</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">      if (!signinTimeLine.isUserSignedIn(user)) {</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">        if (this.currentCapacity &lt; this.maxCapacity) {</span>
<span class="fc" id="L77">          final SigninDataRequestModel signinData = signinRequestModel.getSigninData();</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">          if (signinData.getTemperature() &lt;= Constants.FEVER_TEMPERATURE</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">              &amp;&amp; signinData.getYesQuestion() == null) {</span>

            try {
<span class="fc" id="L82">              final SigninTimeIdPair signInTimeAndId =</span>
<span class="fc" id="L83">                  databaseManager.signinUser(signinRequestModel);</span>
<span class="fc" id="L84">              signinTimeLine.signUserIn(user, signInTimeAndId);</span>
<span class="fc" id="L85">              this.currentCapacity++;</span>
<span class="fc" id="L86">              return new Result(200, &quot;Success&quot;);</span>
<span class="nc" id="L87">            } catch (InterruptedException e) {</span>
<span class="nc" id="L88">              result = new Result(500, &quot;Unable to write to database&quot;);</span>
<span class="nc" id="L89">            }</span>
          } else {
            final String information =
<span class="fc bfc" id="L92" title="All 2 branches covered.">                signinData.getYesQuestion() == null</span>
<span class="fc" id="L93">                    ? &quot;Your temperature is too high: &quot; + signinData.getTemperature()</span>
<span class="fc" id="L94">                    : &quot;You answered yes to \&quot;&quot; + signinData.getYesQuestion() + &quot;\&quot;&quot;;</span>
<span class="fc" id="L95">            result = new Result(412, information);</span>
          }
<span class="fc" id="L97">        } else {</span>
<span class="fc" id="L98">          result = new Result(409, &quot;At Capacity - Try again later&quot;);</span>
        }
      } else {
<span class="fc" id="L101">        result = new Result(405, &quot;User is already signed in&quot;);</span>
      }
    } else {
<span class="nc" id="L104">      result = new Result(404, &quot;User does not exist&quot;);</span>
    }
    // those code runs if a user tries to signin but there is an error
    try {
      // Sign user in and then out
<span class="fc" id="L109">      final SigninTimeIdPair signInTimeAndId = databaseManager.signinUser(signinRequestModel);</span>
<span class="fc" id="L110">      databaseManager.signOutUser(</span>
<span class="fc" id="L111">          signInTimeAndId, Utility.failedSignedoutTimeToFullIso8601String());</span>
<span class="nc" id="L112">    } catch (Exception e) {</span>
<span class="nc" id="L113">      logger.warn(&quot;Error signing user in/out: &quot; + e.toString());</span>
      // do nothing, already returning due to result
<span class="fc" id="L115">    }</span>
<span class="fc" id="L116">    return result;</span>
  }

  public Result signoutUser(final UserRequestModel user) {
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">    if (users.contains(user)) {</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">      if (signinTimeLine.isUserSignedIn(user)) {</span>
        try {
<span class="fc" id="L123">          final SigninTimeIdPair signInId = signinTimeLine.getUserSigninTimeAndId(user);</span>
<span class="fc" id="L124">          this.databaseManager.signOutUser(signInId);</span>
<span class="fc" id="L125">          signinTimeLine.signUserOut(user);</span>
<span class="fc" id="L126">          this.currentCapacity--;</span>
<span class="fc" id="L127">          return new Result(200, &quot;Success&quot;);</span>
<span class="nc" id="L128">        } catch (InterruptedException e) {</span>
<span class="nc" id="L129">          return new Result(500, &quot;Unable to write to database to sign user out&quot;);</span>
        }
      } else {
<span class="fc" id="L132">        return new Result(405, &quot;User is not signed in to be signed out&quot;);</span>
      }
    } else {
<span class="nc" id="L135">      return new Result(404, &quot;User does not exist&quot;);</span>
    }
  }

  public Result createAndSigninUser(final NewUserRequestModel newUserRequestModel) {
<span class="fc" id="L140">    final UserRequestModel user = newUserRequestModel.getUser();</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">    if (users.contains(user)) {</span>
<span class="nc" id="L142">      return new Result(405, &quot;Email &quot; + user.getEmail() + &quot; already exists!&quot;);</span>
    } else {
<span class="fc" id="L144">      signinTimeLine.addUser(user);</span>
<span class="fc" id="L145">      users.add(user);</span>
      try {
<span class="fc" id="L147">        databaseManager.addUser(newUserRequestModel);</span>
<span class="nc" id="L148">      } catch (InterruptedException e) {</span>
<span class="nc" id="L149">        final String errorMessage = &quot;Unable to write new user to database: &quot; + e.toString();</span>
<span class="nc" id="L150">        logger.warn(errorMessage);</span>
<span class="nc" id="L151">        return new Result(500, errorMessage);</span>
<span class="fc" id="L152">      }</span>
      // Sign user in after creating them
<span class="fc" id="L154">      final SigninRequestModel signinRequestModel =</span>
          new SigninRequestModel(
<span class="fc" id="L156">              newUserRequestModel.getSigninData(), newUserRequestModel.getUser());</span>
<span class="fc" id="L157">      return this.signinUser(signinRequestModel);</span>
    }
  }

  public Result deleteUser(final UserRequestModel userModel) {
<span class="fc bfc" id="L162" title="All 2 branches covered.">    if (!users.contains(userModel)) {</span>
<span class="fc" id="L163">      return new Result(405, &quot;Email &quot; + userModel.getEmail() + &quot; does not exist&quot;);</span>
    } else {
      try {
<span class="fc" id="L166">        databaseManager.removeUser(userModel);</span>
<span class="fc" id="L167">        signinTimeLine.removeUser(userModel);</span>
<span class="fc" id="L168">        users.remove(userModel);</span>
<span class="fc" id="L169">        return new Result(200, &quot;Success&quot;);</span>
<span class="nc" id="L170">      } catch (InterruptedException e) {</span>
<span class="nc" id="L171">        final String errorMessage = &quot;Unable to write new user to database: &quot; + e.toString();</span>
<span class="nc" id="L172">        logger.warn(errorMessage);</span>
<span class="nc" id="L173">        return new Result(500, errorMessage);</span>
      }
    }
  }

  public Result userExists(final UserRequestModel user) {
<span class="fc" id="L179">    return new UserExistsResult(200, &quot;&quot;, users.contains(user));</span>
  }

  public void setMaxCapacity(final int newMax) {
<span class="nc" id="L183">    this.maxCapacity = newMax;</span>
<span class="nc" id="L184">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>